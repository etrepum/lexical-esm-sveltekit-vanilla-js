/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
import{INSERT_CHECK_LIST_COMMAND as e,insertList as t,$isListItemNode as n,$isListNode as r}from"@lexical/list";import{useLexicalComposerContext as i}from"@lexical/react/LexicalComposerContext";import{mergeRegister as l,$findMatchingParent as o,isHTMLElement as c}from"@lexical/utils";import{COMMAND_PRIORITY_LOW as u,KEY_ARROW_DOWN_COMMAND as s,KEY_ARROW_UP_COMMAND as a,KEY_ESCAPE_COMMAND as g,KEY_SPACE_COMMAND as f,$getNearestNodeFromDOMNode as d,KEY_ARROW_LEFT_COMMAND as m,$getSelection as p,$isRangeSelection as C,$isElementNode as h}from"lexical";import{useEffect as v}from"react";function E(){const[c]=i();return v((()=>l(c.registerCommand(e,(()=>(t(c,"check"),!0)),u),c.registerCommand(s,(e=>y(e,c,!1)),u),c.registerCommand(a,(e=>y(e,c,!0)),u),c.registerCommand(g,(e=>{if(null!=k()){const e=c.getRootElement();return null!=e&&e.focus(),!0}return!1}),u),c.registerCommand(f,(e=>{const t=k();return!(null==t||!c.isEditable())&&(c.update((()=>{const r=d(t);n(r)&&(e.preventDefault(),r.toggleChecked())})),!0)}),u),c.registerCommand(m,(e=>c.getEditorState().read((()=>{const t=p();if(C(t)&&t.isCollapsed()){const{anchor:i}=t,l="element"===i.type;if(l||0===i.offset){const t=i.getNode(),u=o(t,(e=>h(e)&&!e.isInline()));if(n(u)){const n=u.getParent();if(r(n)&&"check"===n.getListType()&&(l||u.getFirstDescendant()===t)){const t=c.getElementByKey(u.__key);if(null!=t&&document.activeElement!==t)return t.focus(),e.preventDefault(),!0}}}}return!1}))),u),c.registerRootListener(((e,t)=>{null!==e&&(e.addEventListener("click",x),e.addEventListener("pointerdown",_)),null!==t&&(t.removeEventListener("click",x),t.removeEventListener("pointerdown",_))}))))),null}function L(e,t){const n=e.target;if(null===n||!c(n))return;const r=n.firstChild;if(null!=r&&c(r)&&("UL"===r.tagName||"OL"===r.tagName))return;const i=n.parentNode;if(!i||"check"!==i.__lexicalListType)return;const l=e.pageX,o=n.getBoundingClientRect();("rtl"===n.dir?l<o.right&&l>o.right-20:l>o.left&&l<o.left+20)&&t()}function x(e){L(e,(()=>{const t=e.target,r=function(e){let t=e;for(;t;){if(t.__lexicalEditor)return t.__lexicalEditor;t=t.parentNode}return null}(t);null!=r&&r.isEditable()&&r.update((()=>{if(e.target){const e=d(t);n(e)&&(t.focus(),e.toggleChecked())}}))}))}function _(e){L(e,(()=>{e.preventDefault()}))}function k(){const e=document.activeElement;return null!=e&&"LI"===e.tagName&&null!=e.parentNode&&"check"===e.parentNode.__lexicalListType?e:null}function y(e,t,i){const l=k();return null!=l&&t.update((()=>{const o=d(l);if(!n(o))return;const c=function(e,t){let i=t?e.getPreviousSibling():e.getNextSibling(),l=e;for(;null==i&&n(l);)l=l.getParentOrThrow().getParent(),null!=l&&(i=t?l.getPreviousSibling():l.getNextSibling());for(;n(i);){const e=t?i.getLastChild():i.getFirstChild();if(!r(e))return i;i=t?e.getLastChild():e.getFirstChild()}return null}(o,i);if(null!=c){c.selectStart();const n=t.getElementByKey(c.__key);null!=n&&(e.preventDefault(),setTimeout((()=>{n.focus()}),0))}})),!1}export{E as CheckListPlugin};
