/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
import{useLexicalComposerContext as t}from"@lexical/react/LexicalComposerContext";import{createCommand as e,KEY_ARROW_DOWN_COMMAND as n,KEY_ARROW_UP_COMMAND as o,KEY_ESCAPE_COMMAND as l,KEY_TAB_COMMAND as r,KEY_ENTER_COMMAND as i,COMMAND_PRIORITY_LOW as u,$getSelection as c,$isRangeSelection as s}from"lexical";import*as a from"react";import{useLayoutEffect as m,useEffect as d,useState as p,useCallback as f,useMemo as g,useRef as h}from"react";import{mergeRegister as w}from"@lexical/utils";var v="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement?m:d;class y{constructor(t){this.key=t,this.ref={current:null},this.setRefElement=this.setRefElement.bind(this)}setRefElement(t){this.ref={current:t}}}const b=t=>{const e=document.getElementById("typeahead-menu");if(!e)return;const n=e.getBoundingClientRect();n.top+n.height>window.innerHeight&&e.scrollIntoView({block:"center"}),n.top<0&&e.scrollIntoView({block:"center"}),t.scrollIntoView({block:"nearest"})};function E(t,e){const n=t.getBoundingClientRect(),o=e.getBoundingClientRect();return n.top>o.top&&n.top<o.bottom}function C(e,n,o,l){const[r]=t();d((()=>{if(null!=n&&null!=e){const t=r.getRootElement(),e=null!=t?function(t,e){let n=getComputedStyle(t);const o="absolute"===n.position,l=e?/(auto|scroll|hidden)/:/(auto|scroll)/;if("fixed"===n.position)return document.body;for(let e=t;e=e.parentElement;)if(n=getComputedStyle(e),(!o||"static"!==n.position)&&l.test(n.overflow+n.overflowY+n.overflowX))return e;return document.body}(t,!1):document.body;let i=!1,u=E(n,e);const c=function(){i||(window.requestAnimationFrame((function(){o(),i=!1})),i=!0);const t=E(n,e);t!==u&&(u=t,null!=l&&l(t))},s=new ResizeObserver(o);return window.addEventListener("resize",o),document.addEventListener("scroll",c,{capture:!0,passive:!0}),s.observe(n),()=>{s.unobserve(n),window.removeEventListener("resize",o),document.removeEventListener("scroll",c,!0)}}}),[n,r,l,o,e])}const R=e("SCROLL_TYPEAHEAD_OPTION_INTO_VIEW_COMMAND");function x({close:t,editor:e,anchorElementRef:a,resolution:m,options:h,menuRenderFn:y,onSelectOption:E,shouldSplitNodeWithQuery:C=!1,commandPriority:x=u}){const[O,I]=p(null),S=m.match&&m.match.matchingString;d((()=>{I(0)}),[S]);const A=f((n=>{e.update((()=>{const e=null!=m.match&&C?function(t){const e=c();if(!s(e)||!e.isCollapsed())return null;const n=e.anchor;if("text"!==n.type)return null;const o=n.getNode();if(!o.isSimpleText())return null;const l=n.offset,r=o.getTextContent().slice(0,l),i=t.replaceableString.length,u=l-function(t,e,n){let o=n;for(let n=o;n<=e.length;n++)t.substr(-n)===e.substr(0,n)&&(o=n);return o}(r,t.matchingString,i);if(u<0)return null;let a;return 0===u?[a]=o.splitText(l):[,a]=o.splitText(u,l),a}(m.match):null;E(n,e,t,m.match?m.match.matchingString:"")}))}),[e,C,m.match,E,t]),L=f((t=>{const n=e.getRootElement();null!==n&&(n.setAttribute("aria-activedescendant","typeahead-item-"+t),I(t))}),[e]);d((()=>()=>{const t=e.getRootElement();null!==t&&t.removeAttribute("aria-activedescendant")}),[e]),v((()=>{null===h?I(null):null===O&&L(0)}),[h,O,L]),d((()=>w(e.registerCommand(R,(({option:t})=>!(!t.ref||null==t.ref.current)&&(b(t.ref.current),!0)),x))),[e,L,x]),d((()=>w(e.registerCommand(n,(t=>{const n=t;if(null!==h&&h.length&&null!==O){const t=O!==h.length-1?O+1:0;L(t);const o=h[t];null!=o.ref&&o.ref.current&&e.dispatchCommand(R,{index:t,option:o}),n.preventDefault(),n.stopImmediatePropagation()}return!0}),x),e.registerCommand(o,(t=>{const e=t;if(null!==h&&h.length&&null!==O){const t=0!==O?O-1:h.length-1;L(t);const n=h[t];null!=n.ref&&n.ref.current&&b(n.ref.current),e.preventDefault(),e.stopImmediatePropagation()}return!0}),x),e.registerCommand(l,(e=>{const n=e;return n.preventDefault(),n.stopImmediatePropagation(),t(),!0}),x),e.registerCommand(r,(t=>{const e=t;return null!==h&&null!==O&&null!=h[O]&&(e.preventDefault(),e.stopImmediatePropagation(),A(h[O]),!0)}),x),e.registerCommand(i,(t=>null!==h&&null!==O&&null!=h[O]&&(null!==t&&(t.preventDefault(),t.stopImmediatePropagation()),A(h[O]),!0)),x))),[A,t,e,h,O,L,x]);return y(a,g((()=>({options:h,selectOptionAndCleanUp:A,selectedIndex:O,setHighlightedIndex:I})),[A,O,h]),m.match?m.match.matchingString:"")}function O({options:e,onClose:n,onOpen:o,onSelectOption:l,menuRenderFn:r,anchorClassName:i,commandPriority:c=u,parent:s}){const[m]=t(),[g,w]=p(null),v=a.useRef(null),y=function(e,n,o,l=document.body){const[r]=t(),i=h(document.createElement("div")),u=f((()=>{i.current.style.top=i.current.style.bottom;const t=r.getRootElement(),n=i.current,u=n.firstChild;if(null!==t&&null!==e){const{left:r,top:c,width:s,height:a}=e.getRect(),m=i.current.offsetHeight;if(n.style.top=`${c+window.pageYOffset+m+3}px`,n.style.left=`${r+window.pageXOffset}px`,n.style.height=`${a}px`,n.style.width=`${s}px`,null!==u){u.style.top=`${c}`;const e=u.getBoundingClientRect(),o=e.height,l=e.width,i=t.getBoundingClientRect();r+l>i.right&&(n.style.left=`${i.right-l+window.pageXOffset}px`),(c+o>window.innerHeight||c+o>i.bottom)&&c-i.top>o&&(n.style.top=c-o+window.pageYOffset-a+"px")}n.isConnected||(null!=o&&(n.className=o),n.setAttribute("aria-label","Typeahead menu"),n.setAttribute("id","typeahead-menu"),n.setAttribute("role","listbox"),n.style.display="block",n.style.position="absolute",l.append(n)),i.current=n,t.setAttribute("aria-controls","typeahead-menu")}}),[r,e,o,l]);d((()=>{const t=r.getRootElement();if(null!==e)return u(),()=>{null!==t&&t.removeAttribute("aria-controls");const e=i.current;null!==e&&e.isConnected&&e.remove()}}),[r,u,e]);const c=f((t=>{null!==e&&(t||n(null))}),[e,n]);return C(e,i.current,u,c),i}(g,w,i,s),b=f((()=>{w(null),null!=n&&null!==g&&n()}),[n,g]),E=f((t=>{w(t),null!=o&&null===g&&o(t)}),[o,g]),R=f((t=>{t.preventDefault(),E({getRect:()=>new DOMRect(t.clientX,t.clientY,1,1)})}),[E]),O=f((t=>{null===g||null==v.current||null==t.target||v.current.contains(t.target)||b()}),[b,g]);return d((()=>{const t=m.getRootElement();if(t)return t.addEventListener("contextmenu",R),()=>t.removeEventListener("contextmenu",R)}),[m,R]),d((()=>(document.addEventListener("click",O),()=>document.removeEventListener("click",O))),[m,O]),null===g||null===m?null:a.createElement(x,{close:b,resolution:g,editor:m,anchorElementRef:y,options:e,menuRenderFn:(t,e)=>r(t,e,{setMenuRef:t=>{v.current=t}}),onSelectOption:l,commandPriority:c})}export{O as LexicalContextMenuPlugin,y as MenuOption};
